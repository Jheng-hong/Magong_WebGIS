<!DOCTYPE html>
<html>
<head>
    <title>馬公遊廓WebGIS平台</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
    <style>
        #map {
            width: 1520px;
            height: 720px;
            position: relative;
        }
        .layer-select {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 5px;
            z-index: 1000;
        }
        .slider {
            width: 100%;
        }
        .top-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
        }
        .checkbox-group label input {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="layer-select">
        <h4>相關圖徵</h4>
        <div class="checkbox-group">
            <label for="item1"><input type="checkbox" id="item1" name="layer" value="Item1">貸座敷(1906)</label>
            <label for="item2"><input type="checkbox" id="item2" name="layer" value="Item2">貸座敷(1927)</label>
            <label for="item3"><input type="checkbox" id="item3" name="layer" value="Item3">貸座敷(1937)</label>
            <label for="item4"><input type="checkbox" id="item4" name="layer" value="Item4">料理屋(1906)</label>
            <label for="item5"><input type="checkbox" id="item5" name="layer" value="Item5">料理屋(1927)</label>
            <label for="item6"><input type="checkbox" id="item6" name="layer" value="Item6">料理屋(1937)</label>
            <label for="item7"><input type="checkbox" id="item7" name="layer" value="Item7">婦人病院</label>
            <label for="item8"><input type="checkbox" id="item8" name="layer" value="Item8">警察官吏派出所</label>
        </div>
        <h4>家族遷移路線</h4>
        <div class="top-bar">
            <select id="family-select">
                <option value="" disabled selected>家族系統</option>
            </select>
            <select id="member-select">
                <option value="" disabled selected>系統戶主</option>
            </select>
            <button id="display-button">展示</button>
        </div>
        <h4>圖層套疊</h4>
        <form id="layer-form">
            <label for="layer1">遊廓區域(1906): <input type="checkbox" id="layer1" name="layer" value="Layer1"></label>
            <input type="range" class="slider" id="sliderLayer1" min="0" max="1" step="0.1" value="1"><br>
            <label for="layer2">遊廓區域(1913): <input type="checkbox" id="layer2" name="layer" value="Layer2"></label>
            <input type="range" class="slider" id="sliderLayer2" min="0" max="1" step="0.1" value="1"><br>
            <label for="layer3">媽宮街町界: <input type="checkbox" id="layer3" name="layer" value="Layer3"></label>
            <input type="range" class="slider" id="sliderLayer3" min="0" max="1" step="0.1" value="1"><br>
            <label for="layer4">臺灣堡圖(1904): <input type="checkbox" id="layer4" name="layer" value="Layer4"></label>
            <input type="range" class="slider" id="sliderLayer4" min="0" max="1" step="0.1" value="1"><br>
            <label for="layer5">Google地圖: <input type="checkbox" id="layer5" name="layer" value="Layer5"></label>
            <input type="range" class="slider" id="sliderLayer5" min="0" max="1" step="0.1" value="1"><br>
            
        </form>
    </div>
    <script>
        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([119.565, 23.565]),
                zoom: 16
            })
        });

        var baseLayer = new ol.layer.Tile({
            source: new ol.source.OSM(),
            zIndex: 0
        });
        map.addLayer(baseLayer);

        var layers = {
            'Layer1': new ol.layer.Vector({
                source: new ol.source.Vector({
                    url: 'https://raw.githubusercontent.com/Jheng-hong/Magong_WebGIS/main/1906YukakuArea.geojson',
                    format: new ol.format.GeoJSON()
                }),
                opacity: 1,
                style: function(feature) {
                    return new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: 'rgba(255,105,180,1)', 
                            width: 2 
                        }),
                        fill: new ol.style.Fill({
                            color: 'rgba(0,0,0,0)' 
                        }),
                        text: new ol.style.Text({
                            font: '12px Calibri,sans-serif',
                            fill: new ol.style.Fill({
                                color: 'rgba(255,105,180,1)' 
                            }),
                            stroke: new ol.style.Stroke({
                                color: '#fff', 
                                width: 3 
                            }),
                            text: '遊廓(1906)'
                        })
                    });
                },
                zIndex: 5
            }),
            'Layer2': new ol.layer.Vector({
                source: new ol.source.Vector({
                    url: 'https://raw.githubusercontent.com/Jheng-hong/Magong_WebGIS/main/1913YukakuArea.geojson',
                    format: new ol.format.GeoJSON()
                }),
                opacity: 1,
                style: function(feature) {
                    return new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: 'rgba(160,32,240,1)', 
                            width: 2 
                        }),
                        fill: new ol.style.Fill({
                            color: 'rgba(0,0,0,0)' 
                        }),
                        text: new ol.style.Text({
                            font: '12px Calibri,sans-serif',
                            fill: new ol.style.Fill({
                                color: 'rgba(160,32,240,1)' 
                            }),
                            stroke: new ol.style.Stroke({
                                color: '#fff', 
                                width: 3 
                            }),
                            text: '遊廓(1913)'
                        })
                    });
                },
                zIndex: 4
            }),
            'Layer3': new ol.layer.Vector({
                source: new ol.source.Vector({
                    url: 'https://raw.githubusercontent.com/Jheng-hong/Magong_WebGIS/main/MagongOldTownBoundary.geojson',
                    format: new ol.format.GeoJSON()
                }),
                opacity: 1,
                style: function(feature) {
                    return new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: 'red', 
                            width: 2 
                        }),
                        fill: new ol.style.Fill({
                            color: 'rgba(0,0,0,0)' 
                        }),
                        text: new ol.style.Text({
                            font: '12px Calibri,sans-serif',
                            fill: new ol.style.Fill({
                                color: 'red' 
                            }),
                            stroke: new ol.style.Stroke({
                                color: '#fff', 
                                width: 3 
                            }),
                            text: feature.get('町名')
                        })
                    });
                },
                zIndex: 3
            }),
            'Layer4': new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://gis.sinica.edu.tw/tileserver/file-exists.php?img=JM20K_1904-jpg-{z}-{x}-{y}'
                }),
                opacity: 1,
                zIndex: 2
            }),
            'Layer5': new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://mt{0-3}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',
                }),
                opacity: 1,
                zIndex: 1
            }),
        };

        var item1Layer = new ol.layer.Vector({
            source: new ol.source.Vector({
                url: 'https://raw.githubusercontent.com/Jheng-hong/Magong_WebGIS/main/1906L.geojson', 
                format: new ol.format.GeoJSON()
            }),
            style: new ol.style.Style({
                image: new ol.style.Icon({
                    src: 'https://raw.githubusercontent.com/Jheng-hong/Magong_WebGIS/main/lips.png', // 替換為實際的圖標URL
                    scale: 0.05
                })
            })
        });
        map.addLayer(item1Layer);
        item1Layer.setVisible(false);

        Object.keys(layers).forEach(function(key) {
            layers[key].setVisible(false);
            map.addLayer(layers[key]);
        });

        document.getElementById('layer-form').addEventListener('change', function(e) {
            var layer = layers[e.target.value];
            if (e.target.checked) {
                layer.setVisible(true);
            } else {
                layer.setVisible(false);
            }
        });

        document.querySelectorAll('.slider').forEach(function(slider) {
            slider.addEventListener('input', function() {
                var layerId = slider.id.replace('slider', '');
                var layer = layers[layerId];
                layer.setOpacity(parseFloat(slider.value));
            });
        });

        document.getElementById('item1').addEventListener('change', function(e) {
            item1Layer.setVisible(e.target.checked);
        });

        // 加載 JSON 數據並設置選項
        fetch('https://raw.githubusercontent.com/Jheng-hong/Magong_WebGIS/main/test.json')
            .then(response => response.json())
            .then(data => {
                var familySelect = document.getElementById('family-select');
                var memberSelect = document.getElementById('member-select');

                var familySystems = {};
                data.features.forEach(feature => {
                    var familySystem = feature.properties.family_system;
                    var owner = feature.properties.owner;
                    if (!familySystems[familySystem]) {
                        familySystems[familySystem] = [];
                    }
                    if (!familySystems[familySystem].includes(owner)) {
                        familySystems[familySystem].push(owner);
                    }
                });

                Object.keys(familySystems).forEach(familySystem => {
                    var option = document.createElement('option');
                    option.value = familySystem;
                    option.textContent = familySystem;
                    familySelect.appendChild(option);
                });

                familySelect.addEventListener('change', function() {
                    var selectedFamilySystem = familySelect.value;
                    memberSelect.innerHTML = '<option value="" disabled selected>系統戶主</option>';
                    familySystems[selectedFamilySystem].forEach(owner => {
                        var option = document.createElement('option');
                        option.value = owner;
                        option.textContent = owner;
                        memberSelect.appendChild(option);
                    });
                });
            });

        // 計算兩點之間的角度
        function getAngle(coordinate1, coordinate2) {
            var dx = coordinate2[0] - coordinate1[0];
            var dy = coordinate2[1] - coordinate1[1];
            const angleRadians = Math.atan2(dx, dy);
            return angleRadians;
        }

        // 計算線段中點
        function getMidpoint(coordinate1, coordinate2) {
            return [
                (coordinate1[0] + coordinate2[0]) / 2,
                (coordinate1[1] + coordinate2[1]) / 2
            ];
        }

        // 展示按鈕點擊事件處理
        document.getElementById('display-button').addEventListener('click', function() {
            var family = document.getElementById('family-select').value;
            var member = document.getElementById('member-select').value;
            if (family && member) {
                fetch('https://raw.githubusercontent.com/Jheng-hong/Magong_WebGIS/main/test.json')
                    .then(response => response.json())
                    .then(data => {
                        var features = data.features.filter(feature => 
                            feature.properties.family_system === family && feature.properties.owner === member
                        );

                        var vectorSource = new ol.source.Vector({
                            features: (new ol.format.GeoJSON()).readFeatures({
                                type: 'FeatureCollection',
                                features: features
                            }, {
                                featureProjection: 'EPSG:3857' // 確保座標投影正確
                            })
                        });

                        var vectorLayer = new ol.layer.Vector({
                            source: vectorSource,
                            style: function(feature) {
                                var coordinates = feature.getGeometry().getCoordinates();
                                var styles = [];
                                for (var i = 0; i < coordinates.length - 1; i++) {
                                    var start = coordinates[i];
                                    var end = coordinates[i + 1];
                                    var angle = getAngle(start, end);
                                    var midpoint = getMidpoint(start, end);
                                    styles.push(
                                        new ol.style.Style({
                                            geometry: new ol.geom.LineString([start, end]),
                                            stroke: new ol.style.Stroke({
                                                color: 'blue',
                                                width: 2
                                            })
                                        }),
                                        new ol.style.Style({
                                            geometry: new ol.geom.Point(end),
                                            image: new ol.style.Icon({
                                                src: 'https://raw.githubusercontent.com/Jheng-hong/Magong_WebGIS/main/right.png', // 使用箭頭圖標
                                                anchor: [0.5, 0.5],
                                                rotateWithView: true,
                                                rotation: angle-(45/ Math.PI)
                                            })
                                        }),
                                        new ol.style.Style({
                                            geometry: new ol.geom.Point(midpoint),
                                            text: new ol.style.Text({
                                                font: '12px Calibri,sans-serif',
                                                fill: new ol.style.Fill({
                                                    color: 'black'
                                                }),
                                                stroke: new ol.style.Stroke({
                                                    color: 'white',
                                                    width: 2
                                                }),
                                                text: '(' + feature.get('mark') + '): ' + feature.get('time')
                                            })
                                        })
                                    );
                                }
                                return styles;
                            }
                        });

                        // 移除之前的高亮圖層
                        map.getLayers().getArray().forEach(layer => {
                            if (layer.get('name') === 'highlightedLayer') {
                                map.removeLayer(layer);
                            }
                        });

                        vectorLayer.set('name', 'highlightedLayer');
                        map.addLayer(vectorLayer);

                        var extent = vectorSource.getExtent();
                        map.getView().fit(extent, { size: map.getSize(), maxZoom: 18 });
                    });
            } else {
                alert('請選擇家族和家族成員');
            }
        });
    </script>
</body>
</html>
